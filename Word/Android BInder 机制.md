#Android Binder 机制原理

-----
>  Binder是android系统进程间通信（IPC)方式之一。Linux已经拥有的线程间通信IPC 手段包括（Internet Process Connection）：管道（Pipe）、信号（Signal）和跟踪（Trace)、插口（Socket)、报文队列（Message）、共享内存（Share Memory）和信号量（Semaphore)。本文详细介绍Binder作为android主要IPC方式的优势

###一、引言
>  基于Client-Server 的通信方式广泛应用于从互联网和数据库访问到嵌入式手持设备通信等各个领域。只能手机平台特别是android系统中，为了向应用开发者提供丰富多样的功能，这种通信方式更是无处不在，诸如媒体播放、视频音频捕获，到各种让手机更智能的传感器（加速度、方位、温度、光亮度等）都由不同的Server负责管理，应用程序只需要做为Client与这些Server建立连接便可以使用这些服务，花很少量的时间和精力就能开发出令人炫目的功能。Client-Server方式的广泛采用对进程间通信（IPC)机制是一个挑战。目前Linux支持的IPC包括传统的管道，System V IPC ，即消息队列、共享内存、信号量，以及socket中只有socket支持Client-Server的通信方式。当然也可以在这些底层机制上架设一套协议来实现Client-Server通信，但这样增加了系统复杂性，在手机这种条件复杂，资源稀缺的环境下可靠性也难以保证。  
另一方面是传输性能。socket作为一款通用接口，其传输效率低，开销大，主要用在跨网络的进程间通信和本机上进程间的低速通信。消息队列和管道采用存储-转发方式，即数据先从发送方缓存区拷贝到内核开辟的缓存区中，然后再从内核缓存区拷贝到接收方，至少有两次拷贝的过程。共享内存虽然无需靠别，但控制复杂，难以使用。  


各种IPC方式数据拷贝次数

 IPC        | 数据拷贝次数            
 :-------------: |:-------------: 
 共享内存      |  0 
 Binder|1
 Socket/管道/消息队列|2


>  还有一点是处于安全性考虑。终端用户不希望从网上下载的程序在不知情情况下偷窥隐私数据，连接无线网络，长期操作底层设备导致电池很快耗尽等等。传统IPC没有任何安全措施，完全依赖上层协议来确保。首先传统的IPC的接收无法获得对方进程可靠的UIP和PID（用户ID、进程ID）,从而无法鉴别对方身份。Android为每个安装好的应用分配了自己的UID，故进程的UID是鉴别进程身份的重要标志。使用传统IPC只能由用户在数据包里填入UID和PID，但这样不可靠，容易被恶意程序利用。可靠的身份标记只有由IPC机制本身在内核中添加。其次传统IPC访问接入点是开放的，无法建立私有通道。比如命名管道的名称，system v 的键值，socket的IP地址或文件名都是开放的，只要知道这些接入点的程序都可以和对端建立连接，不管怎样都无法阻止恶意程序通过猜测接收方地址获得连接。  
给予以上原因，Android需要建立一套新的IPC机制来满足系统对通信的方式，传输性能和安全性的要求，这就是Binder。Binder基于Client-Server通信模式，传输过程只需要一次拷贝，为发送方添加UID/PID身份，及支持实名Binder也支持匿名Binder，安全性高。

###二、面向对象的Binder IPC 
Binder使用Client-Server通信方式：一个进程作为Server提供诸如视屏/音频解码、视频捕获、地址本查询、网络连接等服务；多个进程作为Client向Server发起服务请求，获取所需要的服务。想要实现Client-Server通信就必须实现以下两点：一是Server必须有确定的访问接入点就是Server主机的IP地址+端口号，传输协议为TCP协议。对Binder而言，Binder可以看成Server提供的实现某个特定服务的访问接入点或者说地址来接收Client的请求，并且Client可以通过某种途径获知Server的地址；二。是制定Command-Reply协议来传输数据。例如在网络通信中Server的访问接入点就是Server主机IP地址+端口号，传输协议为TCP协议。对Binder而言，Binder可以看成Server提供的实现某个特定服务的访问接入点，Client通过这个‘地址’想Server发送请求来使用该服务；对Client而言，Binder可以看成是通向Sever的管道入口，想要摸个Server同行首先必须建立这个管道并获得管道的入口  
与其他的IPC不同，Binder使用了面向对象的思想来描述作为访问接入点的Binder及其在Client中的入口：Binder是一个实体位于Sever中的对象，该对象提供了一套方法用以实现对服务的请求，就想类中的成员函数。遍布于Client中入口可以看成指向这个Binder对象的“指针”，一旦厚的了这个“指针”就是调用该对象的方法访问Server。在Client看来，通过BInder“指针”调用其提供的方法和通过指针调用其他任何本地对象的方法并无区别，尽管前者的实体位于远端Server中，而后者实体位于本地内存中。“指针”是C++的术语，而更通常的说法是引用，即Client通过BInder的引用访问Server。而软件领域的另一个术语“句柄”也可以用来表述Binder在Client中的存在方式。从通信的方式角度看，Client中的Binder也可以看作是Server Binder的代理；而在本地代表远端Server为Client提供服务。  
面向对象思想的引入将进程间通信转化为通过对某个Binder对象的引用，调用该对象的方法，而其独特之处在于Binder对象是一个可以跨进程引用的对象，它的实体位于一个进程中，而它的引用却遍布于系统的各个进程之中。最诱人的是，这个引用和Java里引用一样既可以是强类型，亦可以是弱类型，而且可以从一个进程传给其他京城，让大家都能访问同一Server，就像将一个对象或引用赋值给另一个引用一样。Binder模糊了进程边界，淡化了进程间通信过程，整个系统仿佛运行于同一个面向对象的程序之中。形形色色的Binder对象以及星罗棋布的应用仿佛粘结各个应用程序的胶水，这也是Binder在英文中原意  
当然面向对象只是针对应用程序而言，对于Binder驱动和内核其他模块一样使用C语言实现，没有类和对象的概念，Binder驱动面向对象的进程间通信提供底层支持。







